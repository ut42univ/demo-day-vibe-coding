## 地理メッシュ可視化アプリ 要件定義（Dash + Plotly）

本書は、Dash + Plotly を用いて長崎市内の地理データをメッシュ表示し、ユーザが日付と時間帯を選択できるアプリケーションの要件を定義する。

補足: `README.md` の MVP では「現在時刻のみ」を対象としていたが、本仕様は拡張として「日付・時間帯選択」を含む。MVP との差分は末尾の「README との整合・差分」を参照。

---

## 1. 目的・スコープ

- 目的: 長崎市内における地点ごとのリスク（熱中症リスク=WBGT 近似、凍結リスク=気温ベース）を、メッシュ（コロプレス）で可視化し、ユーザが日付・時間帯を指定して閲覧できるようにする。
- スコープ:
  - 表示: 地図上のメッシュ色分け、凡例、詳細ポップアップ、現在地表示。
  - 時間: 日付（当日を含む近傍日）と時間帯（時刻）を選択し、その時刻のリスクを表示。
  - 対象エリア: 長崎市全域（固定）。
  - データ: Open-Meteo 由来の気象データ（温度、湿度、日射量 等）。

非スコープ（初期リリース）

- 予報の連続アニメーション、時間スライダーの自動再生。
- 住所・施設名検索、ユーザー登録、通知。
- 路面状況・日陰推定・地形陰影等の高度な補正。

---

## 2. 用語

- メッシュ: 長崎市全域を覆う正方格子（GeoJSON Polygon）の集合。以降「グリッド」とも呼ぶ。
- リスク: 熱中症リスク（WBGT 近似）、凍結リスク（気温・降水ベース）の 2 種。
- 時間帯: 1 時間粒度の時刻（例: 2025-09-18 14:00 JST）。

---

## 3. ユースケース（主要）

1. ユーザはアプリを開くと、デフォルトで「現在時刻」のメッシュリスクが表示される。
2. ユーザは日付と時間帯を選択し、その時刻のリスクに地図が更新される。
3. ユーザはメッシュをタップし、そのセルの詳細（リスク種別/レベル、推定 WBGT、気温、湿度、日射量 など）をポップアップで確認できる。
4. ユーザは「現在地表示」ボタンで現在地に地図を移動し、周辺のリスクを確認できる。
5. 凡例で色とリスクレベルの対応を常時確認できる。

---

## 4. 機能要件（FR）

FR-1 地図表示（メッシュ）

- Plotly の ChoroplethMapbox（もしくは Choropleth）でメッシュ（GeoJSON）を色分け表示する。
- 背景地図は OpenStreetMap タイル（Plotly の "open-street-map"）を使用（Mapbox トークン不要）。
- 表示エリアは長崎市の境界を内包するバウンディングボックスにフィット。

FR-2 日付・時間帯選択

- UI コンポーネント: DatePicker と Hour ドロップダウン（または TimePicker / RangeSlider）。
- 粒度: 1 時間。
- 選択範囲（初期仕様）: 今日〜+48 時間（将来の拡張で過去/より先の予報に対応可能）。
- 変更時にメッシュ色が該当時刻の値に更新される。

FR-3 リスク種別の切替

- UI で「熱中症リスク / 凍結リスク」を切替可能。
- 切替時に色分けと凡例が切り替わる。

FR-4 詳細ポップアップ

- セルをクリック/タップすると、以下を表示:
  - 緯度経度（セル中心）/ セル ID
  - リスクレベル（数値/カテゴリ）
  - 熱中症: 推定 WBGT、気温、湿度、日射量、風速（利用時）
  - 凍結: 気温、直近降水量、風速（利用時）
  - データ時刻（JST）

FR-5 凡例

- リスクレベル区分と色を常時表示。
- 凡例は値域としきい値を明示し、単位（°C, W/m² など）を併記。

FR-6 現在地表示

- ブラウザの Geolocation API を用い、現在地へ地図を移動し、ポイントマーカーを表示。
- 位置情報の許諾が得られない場合はガイダンスを表示。

FR-7 エラー/ローディング

- データ取得・計算中はスピナー/ローディング表示。
- 失敗時はユーザ向けに簡潔な再試行案内（ネットワーク、レート制限等）。

---

## 5. 非機能要件（NFR）

- パフォーマンス: 日付/時間帯を変更してから初回レンダリングまで 1.5 秒以内（P50）、3 秒以内（P95）。
- 可用性: シングルノード運用前提だが、エラー時の再試行/キャッシュでユーザ体験を確保。
- アクセシビリティ: 色覚多様性を考慮した配色とツールチップの数値併記。
- セキュリティ/プライバシー: 現在地の座標はクライアント内でのみ使用しサーバ保存しない。
- 監視/ログ: データ取得失敗、計算時間、リクエスト数（レート制限対策）をサーバログに記録。

---

## 6. データ要件

6.1 データソース（Open-Meteo）

- エンドポイント（例）: Forecast API（hourly）, Reanalysis/Archive は将来検討。
- 取得パラメータ（想定）:
  - temperature_2m [°C]
  - relative_humidity_2m [%]
  - shortwave_radiation [W/m²]
  - wind_speed_10m [m/s]（任意: WBGT 補正/風冷感/体感温度）
  - precipitation [mm]（凍結リスクの補助）
- タイムゾーン: Asia/Tokyo。取得値は JST に正規化して扱う。

  6.2 空間解像度・グリッド

- グリッド仕様（初期）: 正方格子 1km メッシュ（バウンディングボックスでクロップ）。
- フォーマット: GeoJSON（Polygon/FeatureCollection）。
- 生成/保管: 事前生成して `data/nagasaki_grid_1km.geojson` に配置し、起動時に読み込み。
- セル属性: id, centroid(lat,lon), polygon, optional: area_km2。

  6.3 セル値の算出

- アプローチ:
  1.  セル中心点の緯度経度を用いて Open-Meteo の補間済み値を取得（推奨: バッチで近傍格子から補間 or API をまとめて呼ぶ）。
  2.  取得値からリスク指標を計算し、セルに割当。
- キャッシュ: （date, hour, variable, cell_id）でメモリ/ディスクキャッシュ。TTL=30〜60 分。

---

## 7. リスク算出ロジック（初期版）

7.1 熱中症リスク（WBGT 近似）

- 目的: 屋外 WBGT の近似を簡易に推定。
- 入力: 気温 T[°C], 湿度 RH[%], 日射量 R[W/m²],（任意で風速 U[m/s]）。
- 計算（例: 一般的近似）:
  - 水蒸気圧 e[hPa] = RH/100 × 6.105 × exp(17.27×T/(237.7+T))
  - 基本近似 WBGT0 = 0.567×T + 0.393×e + 3.94
  - 日射補正: WBGT = WBGT0 + k_r × (R/1000)
    - k_r は経験係数（初期値 2.0〜3.0 程度）を検証で調整。
- レベル区分（仮）: - 28 未満: 注意 - 28〜31: 警戒 - 31〜33: 厳重警戒 - 33 以上: 危険 - 備考: 実地/公的基準に合わせて後日チューニング可能。

  7.2 凍結リスク

- 目的: 路面凍結の可能性を簡易に示す。
- 入力: 気温 T[°C], 降水量 P[mm/h]（直近数時間の総量でも可）,（任意で風速）。
- ロジック（仮）:
  - T ≤ 0°C かつ P > 0: 高
  - T ≤ 0°C かつ P = 0: 中
  - 0°C < T ≤ 2°C かつ P > 0: 中
  - 2°C < T ≤ 4°C かつ P > 0: 低
  - それ以外: 低/なし
- レベルは 0=なし,1=低,2=中,3=高 など整数に正規化。

  7.3 色分け（カラースケール例）

- 熱中症（WBGT）:
  - 注意(〜28): #4CAF50
  - 警戒(28〜31): #FFC107
  - 厳重警戒(31〜33): #FF5722
  - 危険(33+): #B71C1C
- 凍結:
  - なし: #E0F7FA
  - 低: #81D4FA
  - 中: #0288D1
  - 高: #01579B

---

## 8. UI/UX 仕様（Dash 構成）

- ヘッダ: タイトル、説明、現在地ボタン。
- 左ペイン（コントロール）:
  - 日付: DatePickerSingle（既定=今日）
  - 時間: Dropdown（0–23 時）
  - リスク種別: RadioItems（熱中症/凍結）
  - 更新ボタン（任意: 変更と同時更新でも可）
- 右ペイン（地図）:
  - dcc.Graph(go.Choroplethmapbox) に GeoJSON と色分けを適用。
  - クリックイベントで詳細ポップアップ（hover/selectedData で実装）。
- 凡例: 右下固定のカスタム凡例（Plotly Annotation か独自 HTML）。

---

## 9. アーキテクチャ/実装方針

- フレームワーク: Dash（Plotly, dash-core-components, dash-html-components）。
- 構成（例）:
  - app.py: Dash アプリ初期化、レイアウト、コールバック登録。
  - data/grid_loader.py: グリッド GeoJSON のロード/管理。
  - data/meteosvc.py: Open-Meteo 取得、キャッシュ、ユニット/タイムゾーン正規化。
  - logic/risk.py: WBGT 近似/凍結リスク計算、色分けユーティリティ。
  - assets/: CSS（凡例、レスポンシブ調整）。
- コールバック:
  - 入力: 日付、時間、リスク種別 → 出力: Choropleth Figure, 凡例。
  - クリックデータ → 出力: ポップアップ情報パネル。
- キャッシュ: flask_caching（SimpleCache or FileSystemCache）で（date,hour,variable,gridHash）をキーに保存。

---

## 10. エラーハンドリング/レート制限

- Open-Meteo 応答失敗時: 3 回まで指数バックオフ再試行、最後にユーザへ簡易メッセージ。
- タイムアウト: 5〜8 秒で打ち切り、キャッシュ/オフライン値があれば代替表示。
- レート制限対策: 時刻・エリアが同一の要求はキャッシュから返却。フロントの頻回更新をスロットリング（例: 500ms）。

---

## 11. テスト/受け入れ基準

受け入れ基準（例）

- AB-1: 「今日 12 時 / 熱中症」選択で、地図が 1.5 秒以内に更新される（P50）。
- AB-2: 凡例の色と値域が地図の色分けと一致する。
- AB-3: セルをクリックすると詳細に WBGT、気温、湿度、日射量、データ時刻が表示される。
- AB-4: リスク種別を切替えると、色分け・凡例が即時に切り替わる。
- AB-5: 現在地ボタンで地図が現在地へ移動し、マーカーが表示される（許諾時）。
- AB-6: オフライン/取得失敗時にエラーメッセージと再試行リンクが表示される。

テスト観点

- 単体: リスク計算（しきい値境界、極端値）、色分け関数。
- 結合: 指定時刻 → データ取得 → メッシュマップ更新の一連。
- E2E: UI 操作（日時選択、クリック、現在地）。

---

## 12. パフォーマンス最適化（指針）

- グリッド数の上限: ~3,000 セル程度を目安（1km グリッドで市域なら概ね収まる想定）。
- フィギュアの最小化: 不要なトレースや hovertext を簡潔化。
- ベクトル化: NumPy/Pandas で一括計算。Python ループ回避。
- キャッシュ: 同一時刻・同一種別の再計算を避ける。

---

## 13. 配布/運用

- 依存: Python 3.10+、dash、plotly、flask_caching、requests、numpy、pandas。
- 起動: 単一プロセスの Gunicorn/Waitress などで提供（開発時は `app.run_server(debug=True)`）。
- 環境変数: PORT、（必要に応じてプロキシ設定）。

---

## 14. 制約・リスク

- WBGT の近似は簡易であり、実測と差異が出る可能性（検証と係数調整が前提）。
- Open-Meteo の空間補間と当方グリッドの分解能差による誤差。
- 凍結は路面条件（昼夜/日陰/標高差/海風等）を無視した簡易モデル。

---

## 15. README との整合・差分

- README（MVP）では「今のみ」を明示。本仕様では「日付・時間帯選択」を追加する拡張である。
- 運用上はフラグで機能 ON/OFF 可能にし、MVP 発表時点では「現在時刻固定」モードで提供、デモや検証時には選択 UI を有効化する運用を想定。

---

## 付録 A: 代表的 UI ワイヤ（テキスト）

- ヘッダ: [タイトル] [現在地]  
  左: [日付: DatePicker] [時間: 0..23] [種別: 熱中症/凍結]  
  右: [地図: メッシュ色分け + 凡例（右下固定）]  
  クリック: [詳細パネル（右上ポップ）]

---

## 付録 B: データカラム例（セル詳細）

- cell_id, lat, lon
- risk_type, risk_level, risk_score
- wbgt, temperature_c, relative_humidity_pct, shortwave_radiation_wpm2, wind_speed_ms, precipitation_mm
- timestamp_jst
