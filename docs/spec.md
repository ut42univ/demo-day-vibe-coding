# MVP 要件定義書 — demo-day-vibe-coding

最終更新: 2025-09-18 / 作成者: プロダクトチーム

本書は README の MVP コンセプトをもとに、実装・検証に必要な要件を定義します。対象は「今の時点の熱中症（WBGT 近似）／凍結リスクを、長崎市の三次メッシュ上で色分け表示する」最小機能です。

## 1. 目的・背景・ゴール

- 目的: 「今、この場所がどれくらい危険か？」を、地図を開いた瞬間に直感的に理解できる状態を提供する。
- 対象エリア: 長崎市全域（e-Stat の三次メッシュ ≒ 約 1km 四方）。
- 指標: 2 種類
  - 熱中症リスク（WBGT 近似）
  - 凍結リスク（気温ベース）
- ゴール（MVP）: 現在時刻のリスクをコロプレス図で表示し、基本的な地図操作・凡例・現在地表示・メッシュタップでの詳細表示ができること。

## 2. スコープ／非スコープ

### 2.1 スコープ（Must-Have）

- 現在時刻のリスク算出（熱中症 WBGT 近似／凍結）
- メッシュ単位の色分け表示（コロプレス）
- 地図のパン／ズーム
- 現在地表示ボタン（ブラウザの Geolocation API）
- 凡例（常時表示）
- メッシュタップの詳細ポップアップ（リスクレベル、現在の気温など）

### 2.2 非スコープ（Not in MVP）

- 予報・タイムスライダー・アニメーション
- 検索（住所・施設）
- ユーザー登録、マイ地点、通知（プッシュ等）

## 3. 想定ユーザーとユースケース

- 市民・来訪者が、屋外活動の直前／最中に「いま」のリスクを把握。
- 市内のエリア比較（パン・ズームで確認）。
- 現在地近辺のリスク把握（現在地ボタン）。

## 4. 機能要件（Functional Requirements）

FR-1 地図表示

- 長崎市の三次メッシュ GeoJSON をレイヤーとして表示する。
- メッシュごとにリスクレベルに応じた塗り色を適用する。
- ズーム・パンは標準の地図操作で可能。

FR-2 レイヤー切替

- 表示する指標を「熱中症（WBGT 近似）」と「凍結」の 2 つから切替可能（トグルまたはセレクト）。

FR-3 凡例（レジェンド）

- 画面右下（または右上）に常時表示。
- 色とラベル（リスクレベル）を一致させる。
- 現在表示中の指標に応じて凡例内容を切り替える。

FR-4 現在地表示

- 現在地ボタンでブラウザの位置情報許可を促し、現在地を地図上にマーカー表示。
- 位置情報は端末ローカルで使用し、サーバ保存は行わない（詳細は非機能／セキュリティ参照）。

FR-5 詳細ポップアップ

- メッシュをタップ／クリックするとポップアップを表示。
- 表示項目（例）:
  - 共通: メッシュ ID、最終更新時刻（データ時刻）
  - 熱中症: リスクレベル、WBGT 近似値（小数 1 桁）、気温、相対湿度、短波放射、風速
  - 凍結: リスクレベル、気温（小数 1 桁）

FR-6 データ更新

- アプリ起動時に最新データを取得。
- 再取得操作（手動リフレッシュ）を想定（自動ポーリングは任意。MVP では手動でも可）。

FR-7 エラーハンドリング

- データ未取得／API 障害時は「データ未取得」を示す UI（トースト等）とグレー塗りのフォールバックを表示。

## 5. UI/UX 要件

- 最初の描画で 3〜5 色の色分けが視認できる対比を確保。
- 色覚多様性に配慮した配色（推奨パレットを後述）。
- モバイル優先。主要 UI（凡例・トグル・現在地ボタン）は親指で届く位置に配置。
- 地図キャンバスを最大化し、サイドバーは持たない（MVP）。

## 6. 指標の算出ロジック（Contract）

入力（共通）

- 緯度経度（メッシュ重心）: (lat, lon)
- 現在時刻の気象データ（Open-Meteo）:
  - 気温: T [°C]（2m）
  - 相対湿度: RH [%]
  - 短波放射（水平面）: GHI [W/m²]
  - 風速: U [m/s]（10m）

出力（共通）

- 各メッシュのプロパティ:
  - risk_index: "heat" | "freeze"
  - risk_level: 離散カテゴリ（後述）
  - score: 指標の連続値（WBGT 近似[°C] または 気温[°C]）
  - observed_at: ISO8601
  - source: "open-meteo"

### 6.1 熱中症リスク（WBGT 近似）

注意: 本近似は簡易推定であり、医学的判断や業務上の安全管理の代替ではありません。

1. 水蒸気圧の近似（hPa）

$$
\begin{aligned}
e &= \frac{RH}{100} \cdot e_s(T) \\
e_s(T) &= 6.1078 \cdot \exp\left(\frac{17.2694\,T}{237.3+T}\right)
\end{aligned}
$$

2. 室内 WBGT 近似（Steadman 系の近似式を簡略化）

$$\mathrm{WBGT}_{in} \approx 0.567\,T + 0.393\,e + 3.94$$

3. 日射・風の補正（屋外簡易補正）

$$\mathrm{adj}_{solar} = \min\bigl(3.0,\; 0.0025 \times \mathrm{GHI}\bigr)$$

$$
\mathrm{adj}_{wind} = \begin{cases}
0.5 & (U \ge 5\,\mathrm{m/s}) \\
0 & (U < 5\,\mathrm{m/s})
\end{cases}
$$

最終値:

$$\mathrm{WBGT} = \mathrm{WBGT}_{in} + \mathrm{adj}_{solar} - \mathrm{adj}_{wind}$$

4. リスクレベル区分（環境省の区分に準拠した近似）

- 危険: WBGT ≥ 31
- 厳重警戒: 28 ≤ WBGT < 31
- 警戒: 25 ≤ WBGT < 28
- 注意: 21 ≤ WBGT < 25
- 低: WBGT < 21

推奨配色（例・色覚配慮版）

- 危険: #8B0000（深紅）
- 厳重警戒: #E64A19（ディープオレンジ 700）
- 警戒: #FFA726（オレンジ 400）
- 注意: #FFD54F（アンバー 300）
- 低: #66BB6A（グリーン 400）

表示値

- ポップアップには WBGT（小数 1 桁）と T, RH, GHI, U を併記。

### 6.2 凍結リスク（気温ベース）

最終値: score = 気温 T [°C]

区分（道路凍結リスクの簡易判断）

- 危険（凍結確実）: T ≤ -2.0
- 厳重警戒: -2.0 < T ≤ -0.5
- 警戒: -0.5 < T ≤ 0.5
- 低: T > 0.5

配色（例・コールドスキーム）

- 危険: #0D47A1
- 厳重警戒: #1976D2
- 警戒: #64B5F6
- 低: #B3E5FC

表示値

- ポップアップには T（小数 1 桁）を表示。

## 7. データ要件 / API

データソース

- 気象: Open-Meteo API（現在値）
  - 例: temperature_2m, relative_humidity_2m, shortwave_radiation, wind_speed_10m
- 地図: e-Stat 三次メッシュ（長崎市、GeoJSON 化）

取得・更新

- バックエンド（推奨）で 10 分間隔で最新値を集約し、メッシュごとに計算してキャッシュ。
- フロントは単一の GeoJSON（またはベクタタイル）を取得して描画。

API（MVP の最小例）

- GET /api/mesh-risk?index=heat|freeze
  - 応答: GeoJSON FeatureCollection
  - Feature.properties: { mesh_id, risk_index, risk_level, score, observed_at, T, RH, GHI, U }
  - 送信量目安: 長崎市全域で数百〜千数百メッシュ。GeoJSON でも数 MB 程度を想定（圧縮推奨）。

エッジケース

- 夜間（GHI≈0）の場合、adj_solar≈0。
- 測定欠損のメッシュは補間（最近傍）または "no-data" とし、グレー表示。

## 8. アーキテクチャ（MVP 推奨最小構成）

- フロントエンド: Web（Leaflet/MapLibre 等、技術選定は実装都合で可）
- バックエンド: サーバレス関数 or 軽量サーバ（Open-Meteo からの集約・計算・キャッシュ）
- データ更新: 10 分毎の定期ジョブ（Cron）
- 配信: CDN キャッシュ（API 応答に短寿命キャッシュを付与）

## 9. 非機能要件（NFR）

- パフォーマンス
  - ファーストレンダー: モバイル 4G で 3 秒以内（目標）
  - パン／ズームの操作は 60fps 目標（モバイル Safari/Chrome）
- 可用性
  - 99%（MVP 段階の目標）
- セキュリティ／プライバシー
  - 現在地は端末内でのみ使用し、サーバ送信・保存しない。
  - API 鍵不要（Open-Meteo 想定）。第三者への過度なリクエスト集中を避けるため、サーバ側集約を推奨。
- 対応環境
  - iOS Safari 最新版、Android Chrome 最新版、デスクトップ Chrome/Edge/Safari 最新版
- アクセシビリティ
  - 色覚多様性対応（凡例テキスト必須、彩度/明度差を十分に）
  - ボタンのタップ領域は 44px 以上

## 10. 受入基準（Acceptance Criteria）

AC-1 地図表示と操作

- アプリ起動で長崎市のメッシュコロプレスが表示される。
- パン・ズームがスムーズに機能する。

AC-2 レイヤー切替

- 熱中症／凍結の切替ができ、凡例も同期して切り替わる。

AC-3 凡例（常時表示）

- 表示中の指標に対応した色とラベルが正しく表示される。

AC-4 現在地表示

- 位置情報許可時に現在地マーカーが表示され、許可拒否時は丁寧なメッセージが出る。

AC-5 ポップアップ

- 任意メッシュをタップすると、定義済み項目が表示され、値の単位・丸めが期待通りである。

AC-6 データ更新

- 初回ロード時に最新データが取得される。データ時刻がポップアップで確認できる。

AC-7 エラー時挙動

- API 障害・データ欠損時にフォールバック表示とエラートーストが出る。

## 11. 運用・監視（MVP）

- 更新ジョブの失敗監視（失敗時に通知：メール/Slack 等）
- API 応答の健全性チェック（200 率、応答時間）
- フロントエンドのエラーログ（Sentry 等は任意）

## 12. 制約・リスク・前提

- WBGT 近似は簡易推定であり、正確な WBGT（黒球温度等を用いる）とは異なる。
- Open-Meteo の空間分解能と地形特性により、局所的な誤差が生じ得る。
- メッシュ境界で値が不連続になる可能性（補間戦略の簡易性による）。
- クライアントから Open-Meteo へ大量の同時リクエストは行わない（集約サーバで対処）。

## 13. 用語集

- WBGT: Wet Bulb Globe Temperature（暑さ指数）。本 MVP では簡易近似を表示。
- GHI: Global Horizontal Irradiance（短波放射・水平面日射量）
- 三次メッシュ: 約 1km 四方の格子（日本の地域メッシュ）

---

付録 A: カラーパレット（代替案）

- 熱中症（高コントラスト案）
  - 危険: #B71C1C, 厳重警戒: #F4511E, 警戒: #FB8C00, 注意: #FFEE58, 低: #81C784
- 凍結（色弱配慮案）
  - 危険: #102A83, 厳重警戒: #1E88E5, 警戒: #90CAF9, 低: #E3F2FD

付録 B: プロパティ仕様（例）

```json
{
  "mesh_id": "5235-12-45",
  "risk_index": "heat",
  "risk_level": "厳重警戒",
  "score": 29.4,
  "observed_at": "2025-09-18T04:30:00Z",
  "T": 31.2,
  "RH": 62,
  "GHI": 720,
  "U": 3.1
}
```

付録 C: 既知の限界

- 日射・風補正は経験的な係数であり、季節・地表面条件で誤差が増える可能性。
- 凍結は路面状態（濡れ/日陰/放射冷却）を考慮していないため、近似的な注意喚起に留まる。
